---
- hosts: update
  tasks:
    - name: Update all installed packages using YUM module
      yum:
        name: '*'
        state: latest
        update_cache: yes
        update_only: yes
        #autoremove: yes
      register: yum_updates

    - name: Install Yum Utilities
      yum:
        name: yum-utils
        state: latest

    - name: check to see if we need a reboot
      command: needs-restarting -r
      register: result
      ignore_errors: yes

    - debug:
        var: yum_updates

    - debug:
        var: result.stdout_lines

    - name: Reboot Server if Necessary
      reboot:
      async: 30
      poll: 0
      when: result.rc == 1

    # This pause is mandatory, otherwise the existing control connection
    # gets reused!
    # (https://gist.github.com/infernix/a968f23c4f4e1d6723e4)
    #- name: Pausing to allow server to shutdown and terminate our SSH connection
    #  pause: seconds=30
    #  when: result.rc == 1
#
    #- name: Wait for reboot to complete and SSH to become available
    #  local_action: wait_for host "{{ inventory_hostname }}"
    #    state=started delay=30 timeout=60
    #  retries: 3
    #  delay: 10
    #  when: result.rc == 1
